version: '3.8'

services:
  # ===========================================
  # ENEOS Sales Automation API
  # ===========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: eneos-sales-automation
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Brevo
      - BREVO_WEBHOOK_SECRET=${BREVO_WEBHOOK_SECRET}
      # Google
      - GOOGLE_SERVICE_ACCOUNT_EMAIL=${GOOGLE_SERVICE_ACCOUNT_EMAIL}
      - GOOGLE_PRIVATE_KEY=${GOOGLE_PRIVATE_KEY}
      - GOOGLE_SHEET_ID=${GOOGLE_SHEET_ID}
      - LEADS_SHEET_NAME=${LEADS_SHEET_NAME:-Leads}
      - DEDUP_SHEET_NAME=${DEDUP_SHEET_NAME:-Deduplication_Log}
      - SALES_TEAM_SHEET_NAME=${SALES_TEAM_SHEET_NAME:-Sales_Team}
      # Gemini
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-flash}
      # LINE
      - LINE_CHANNEL_ACCESS_TOKEN=${LINE_CHANNEL_ACCESS_TOKEN}
      - LINE_CHANNEL_SECRET=${LINE_CHANNEL_SECRET}
      - LINE_GROUP_ID=${LINE_GROUP_ID}
      # Features
      - ENABLE_AI_ENRICHMENT=${ENABLE_AI_ENRICHMENT:-true}
      - ENABLE_DEDUPLICATION=${ENABLE_DEDUPLICATION:-true}
      - ENABLE_LINE_NOTIFICATIONS=${ENABLE_LINE_NOTIFICATIONS:-true}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - eneos-network

networks:
  eneos-network:
    driver: bridge
