
> eneos-sales-automation@1.0.0 test
> vitest run

[33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m

[1m[7m[36m RUN [39m[27m[22m [36mv2.1.9 [39m[90mC:/Users/Jiraw/OneDrive/Documents/Eneos/eneos-sales-automation[39m

 [32mâœ“[39m src/__tests__/utils/date-formatter.test.ts [2m([22m[2m45 tests[22m[2m)[22m[90m 47[2mms[22m[39m
 [32mâœ“[39m src/__tests__/utils/metrics.test.ts [2m([22m[2m27 tests[22m[2m)[22m[90m 53[2mms[22m[39m
 [32mâœ“[39m src/__tests__/middleware/admin-auth.test.ts [2m([22m[2m36 tests[22m[2m)[22m[33m 834[2mms[22m[39m
   [33m[2mâœ“[22m[39m Admin Auth Middleware[2m > [22madminAuthMiddleware[2m > [22mshould throw error when authorization header is missing [33m784[2mms[22m[39m
 [32mâœ“[39m src/__tests__/middleware/error-handler.test.ts [2m([22m[2m34 tests[22m[2m)[22m[90m 47[2mms[22m[39m
 [32mâœ“[39m src/__tests__/validators/admin.validators.test.ts [2m([22m[2m54 tests[22m[2m)[22m[90m 51[2mms[22m[39m
 [32mâœ“[39m src/__tests__/api-contract.test.ts [2m([22m[2m52 tests[22m[2m)[22m[90m 54[2mms[22m[39m
 [32mâœ“[39m src/__tests__/services/sheets.service.test.ts [2m([22m[2m78 tests[22m[2m)[22m[90m 132[2mms[22m[39m
 [32mâœ“[39m src/__tests__/controllers/admin/helpers/helpers.test.ts [2m([22m[2m64 tests[22m[2m)[22m[90m 60[2mms[22m[39m
 [32mâœ“[39m src/__tests__/templates/flex-message.test.ts [2m([22m[2m34 tests[22m[2m)[22m[90m 24[2mms[22m[39m
 [32mâœ“[39m src/__tests__/services/sheets-team-management.test.ts [2m([22m[2m20 tests[22m[2m)[22m[90m 25[2mms[22m[39m
 [32mâœ“[39m src/__tests__/services/line.service.test.ts [2m([22m[2m20 tests[22m[2m)[22m[90m 35[2mms[22m[39m
[90mstdout[2m | src/__tests__/controllers/admin/activity-log.controller.test.ts[2m > [22m[2mActivity Log Controller[2m > [22m[2mGET /api/admin/activity-log (getActivityLog)[2m > [22m[2mshould pass errors to next middleware
[22m[39m{"error":{},"level":"error","message":"getActivityLog failed","query":{},"service":"eneos-automation","timestamp":"2026-01-26T05:10:09.477Z"}

 [32mâœ“[39m src/__tests__/controllers/admin/activity-log.controller.test.ts [2m([22m[2m16 tests[22m[2m)[22m[90m 46[2mms[22m[39m
 [32mâœ“[39m src/__tests__/services/dead-letter-queue.test.ts [2m([22m[2m28 tests[22m[2m)[22m[90m 65[2mms[22m[39m
 [32mâœ“[39m src/__tests__/services/deduplication.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 8744[2mms[22m[39m
   [33m[2mâœ“[22m[39m Deduplication Service[2m > [22mcheckAndMark[2m > [22mshould return false for new lead and mark as processed [33m1473[2mms[22m[39m
   [33m[2mâœ“[22m[39m Deduplication Service[2m > [22mcheckAndMark[2m > [22mshould return true for duplicate in Google Sheets [33m1281[2mms[22m[39m
   [33m[2mâœ“[22m[39m Deduplication Service[2m > [22mcheckOrThrow[2m > [22mshould throw DuplicateLeadError for existing lead [33m1419[2mms[22m[39m
   [33m[2mâœ“[22m[39m Deduplication Service[2m > [22misDuplicate[2m > [22mshould return false for non-duplicate [33m722[2mms[22m[39m
   [33m[2mâœ“[22m[39m Deduplication Service with Redis[2m > [22mshould check Redis first when available [33m589[2mms[22m[39m
   [33m[2mâœ“[22m[39m Deduplication Service with Redis[2m > [22mshould sync to Redis when found in memory cache [33m711[2mms[22m[39m
   [33m[2mâœ“[22m[39m Deduplication Service - disabled[2m > [22mshould return false for checkAndMark when disabled [33m1276[2mms[22m[39m
   [33m[2mâœ“[22m[39m Deduplication Service - disabled[2m > [22mshould return false for isDuplicate when disabled [33m759[2mms[22m[39m
 [32mâœ“[39m src/__tests__/controllers/admin.controller.campaigns.test.ts [2m([22m[2m11 tests[22m[2m)[22m[90m 52[2mms[22m[39m
 [32mâœ“[39m src/__tests__/controllers/admin.controller.trend.test.ts [2m([22m[2m16 tests[22m[2m)[22m[90m 75[2mms[22m[39m
 [32mâœ“[39m src/__tests__/controllers/line.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 4618[2mms[22m[39m
   [33m[2mâœ“[22m[39m LINE Controller[2m > [22mhandleLineWebhook[2m > [22mshould respond immediately with 200 [33m3733[2mms[22m[39m
[90mstdout[2m | src/__tests__/controllers/admin.controller.test.ts[2m > [22m[2mAdmin Controller[2m > [22m[2mgetDashboard[2m > [22m[2mshould handle getAllLeads error gracefully and return empty data
[22m[39m{"error":"Database error","level":"error","message":"Failed to get all leads - dashboard will show empty data","service":"eneos-automation","stack":"Error: Database error\n    at C:\\Users\\Jiraw\\OneDrive\\Documents\\Eneos\\eneos-sales-automation\\src\\__tests__\\controllers\\admin.controller.test.ts:249:41\n    at file:///C:/Users/Jiraw/OneDrive/Documents/Eneos/eneos-sales-automation/node_modules/@vitest/runner/dist/index.js:146:14\n    at file:///C:/Users/Jiraw/OneDrive/Documents/Eneos/eneos-sales-automation/node_modules/@vitest/runner/dist/index.js:533:11\n    at runWithTimeout (file:///C:/Users/Jiraw/OneDrive/Documents/Eneos/eneos-sales-automation/node_modules/@vitest/runner/dist/index.js:39:7)\n    at runTest (file:///C:/Users/Jiraw/OneDrive/Documents/Eneos/eneos-sales-automation/node_modules/@vitest/runner/dist/index.js:1056:17)\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at runSuite (file:///C:/Users/Jiraw/OneDrive/Documents/Eneos/eneos-sales-automation/node_modules/@vitest/runner/dist/index.js:1205:15)\n    at runSuite (file:///C:/Users/Jiraw/OneDrive/Documents/Eneos/eneos-sales-automation/node_modules/@vitest/runner/dist/index.js:1205:15)\n    at runSuite (file:///C:/Users/Jiraw/OneDrive/Documents/Eneos/eneos-sales-automation/node_modules/@vitest/runner/dist/index.js:1205:15)\n    at runFiles (file:///C:/Users/Jiraw/OneDrive/Documents/Eneos/eneos-sales-automation/node_modules/@vitest/runner/dist/index.js:1262:5)","timestamp":"2026-01-26T05:10:13.216Z"}

 [32mâœ“[39m src/__tests__/controllers/admin.controller.test.ts [2m([22m[2m54 tests[22m[2m)[22m[90m 213[2mms[22m[39m
 [32mâœ“[39m src/__tests__/controllers/webhook.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 11882[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Controller[2m > [22mhandleBrevoWebhook[2m > [22mshould process valid click event successfully [33m4604[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Controller[2m > [22mhandleBrevoWebhook - feature flags[2m > [22mshould skip AI enrichment when disabled [33m1186[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Controller[2m > [22mhandleBrevoWebhook - feature flags[2m > [22mshould skip LINE notification when disabled [33m1349[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Controller[2m > [22mtestWebhook[2m > [22mshould return 403 in production mode [33m1459[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Controller[2m > [22mtestWebhook[2m > [22mshould return mock payload in development mode [33m935[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Controller[2m > [22mtestWebhook[2m > [22mshould inject mock payload into request body [33m2253[2mms[22m[39m
 [32mâœ“[39m src/__tests__/validators/line.validator.test.ts [2m([22m[2m30 tests[22m[2m)[22m[90m 28[2mms[22m[39m
 [32mâœ“[39m src/__tests__/services/redis.service.test.ts [2m([22m[2m28 tests[22m[2m)[22m[90m 37[2mms[22m[39m
 [32mâœ“[39m src/__tests__/services/gemini.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[90m 21[2mms[22m[39m
 [32mâœ“[39m src/__tests__/constants/admin.constants.test.ts [2m([22m[2m27 tests[22m[2m)[22m[90m 31[2mms[22m[39m
[90mstdout[2m | src/__tests__/controllers/admin/team-management.controller.test.ts[2m > [22m[2mTeam Management Controller[2m > [22m[2mGET /api/admin/sales-team (getSalesTeamList)[2m > [22m[2mshould pass errors to next middleware
[22m[39m{"error":{},"level":"error","message":"getSalesTeamList failed","service":"eneos-automation","timestamp":"2026-01-26T05:10:18.646Z"}

 [32mâœ“[39m src/__tests__/controllers/admin/team-management.controller.test.ts [2m([22m[2m16 tests[22m[2m)[22m[90m 48[2mms[22m[39m
 [32mâœ“[39m src/__tests__/controllers/admin.controller.team.test.ts [2m([22m[2m7 tests[22m[2m)[22m[90m 26[2mms[22m[39m
 [32mâœ“[39m src/__tests__/controllers/admin.controller.export.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 8771[2mms[22m[39m
   [33m[2mâœ“[22m[39m Admin Controller - Export[2m > [22mGET /api/admin/export - XLSX Format[2m > [22mshould export leads to xlsx format [33m1052[2mms[22m[39m
   [33m[2mâœ“[22m[39m Admin Controller - Export[2m > [22mGET /api/admin/export - XLSX Format[2m > [22mshould apply date filters when exporting [33m1251[2mms[22m[39m
   [33m[2mâœ“[22m[39m Admin Controller - Export[2m > [22mGET /api/admin/export - XLSX Format[2m > [22mshould apply campaign filter when exporting [33m3138[2mms[22m[39m
   [33m[2mâœ“[22m[39m Admin Controller - Export[2m > [22mGET /api/admin/export - XLSX Format[2m > [22mshould limit export to MAX_ROWS [33m2942[2mms[22m[39m
 [32mâœ“[39m src/__tests__/utils/email-parser.test.ts [2m([22m[2m25 tests[22m[2m)[22m[90m 20[2mms[22m[39m
 [32mâœ“[39m src/__tests__/utils/uuid.test.ts [2m([22m[2m11 tests[22m[2m)[22m[90m 20[2mms[22m[39m
 [32mâœ“[39m src/__tests__/utils/phone-formatter.test.ts [2m([22m[2m22 tests[22m[2m)[22m[90m 18[2mms[22m[39m
 [32mâœ“[39m src/__tests__/middleware/request-context.test.ts [2m([22m[2m7 tests[22m[2m)[22m[90m 25[2mms[22m[39m
 [32mâœ“[39m src/__tests__/validators/brevo.validator.test.ts [2m([22m[2m18 tests[22m[2m)[22m[90m 32[2mms[22m[39m
[90mstdout[2m | src/__tests__/utils/retry.test.ts[2m > [22m[2mRetry Utility[2m > [22m[2mCircuitBreaker[2m > [22m[2mshould open after threshold failures
[22m[39m{"level":"error","message":"Circuit breaker opened after 3 failures","service":"eneos-automation","timestamp":"2026-01-26T05:10:25.785Z"}

[90mstdout[2m | src/__tests__/utils/retry.test.ts[2m > [22m[2mRetry Utility[2m > [22m[2mCircuitBreaker[2m > [22m[2mshould reject immediately when open
[22m[39m{"level":"error","message":"Circuit breaker opened after 1 failures","service":"eneos-automation","timestamp":"2026-01-26T05:10:25.791Z"}

[90mstdout[2m | src/__tests__/utils/retry.test.ts[2m > [22m[2mRetry Utility[2m > [22m[2mCircuitBreaker[2m > [22m[2mshould reset to closed after successful call in half-open
[22m[39m{"level":"error","message":"Circuit breaker opened after 1 failures","service":"eneos-automation","timestamp":"2026-01-26T05:10:25.794Z"}

[90mstdout[2m | src/__tests__/utils/retry.test.ts[2m > [22m[2mRetry Utility[2m > [22m[2mCircuitBreaker[2m > [22m[2mshould allow manual reset
[22m[39m{"level":"error","message":"Circuit breaker opened after 1 failures","service":"eneos-automation","timestamp":"2026-01-26T05:10:25.957Z"}

 [32mâœ“[39m src/__tests__/utils/retry.test.ts [2m([22m[2m10 tests[22m[2m)[22m[90m 199[2mms[22m[39m
 [32mâœ“[39m src/__tests__/app.test.ts [2m([22m[2m17 tests[22m[2m)[22m[90m 213[2mms[22m[39m
 [32mâœ“[39m src/__tests__/routes/admin.routes.trend.test.ts [2m([22m[2m14 tests[22m[2m)[22m[90m 184[2mms[22m[39m

[2m Test Files [22m [1m[32m34 passed[39m[22m[90m (34)[39m
[2m      Tests [22m [1m[32m909 passed[39m[22m[90m (909)[39m
[2m   Start at [22m 12:09:50
[2m   Duration [22m 37.59s[2m (transform 30.69s, setup 15.41s, collect 137.34s, tests 36.73s, environment 16ms, prepare 32.50s)[22m

