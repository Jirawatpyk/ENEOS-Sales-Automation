# Load Testing - ENEOS Sales Automation

Load testing suite using [k6](https://k6.io/) for performance validation.

## Prerequisites

### Install k6

**Windows (Chocolatey):**
```bash
choco install k6
```

**Windows (Winget):**
```bash
winget install k6 --source winget
```

**macOS:**
```bash
brew install k6
```

**Docker:**
```bash
docker pull grafana/k6
```

## Test Files

| File | Description | Target |
|------|-------------|--------|
| `health.js` | Health endpoint load test | `/health` |
| `api-admin.js` | Admin API endpoints | `/api/admin/*` |
| `webhook-brevo.js` | Brevo webhook stress test | `/webhook/brevo` |

## Running Tests

### 1. Start the server first
```bash
npm run dev
# or
npm start
```

### 2. Run load tests

**Quick health check:**
```bash
npm run test:load:health
# or
k6 run tests/load/health.js
```

**Admin API test:**
```bash
npm run test:load:api
# or
k6 run tests/load/api-admin.js
```

**Webhook stress test:**
```bash
npm run test:load:webhook
# or
k6 run tests/load/webhook-brevo.js
```

**Run all load tests:**
```bash
npm run test:load
```

### 3. With custom environment

```bash
# Against staging
k6 run -e BASE_URL=https://staging.example.com tests/load/health.js

# With auth token
k6 run -e AUTH_TOKEN=your-token tests/load/api-admin.js

# With webhook secret
k6 run -e BREVO_WEBHOOK_SECRET=your-secret tests/load/webhook-brevo.js
```

## Test Scenarios

### health.js - Health Endpoint
- **Ramp up:** 10 users over 30s
- **Sustained:** 10 users for 1 minute
- **Peak:** 50 users for 1 minute
- **Threshold:** p95 < 500ms, error rate < 1%

### api-admin.js - Admin APIs
- **Ramp up:** 5 users, then 20 users
- **Tests:** Dashboard, Leads (paginated), Sales Performance
- **Threshold:** p95 < 2000ms, error rate < 5%

### webhook-brevo.js - Webhook Stress Test
- **Normal load:** 10 requests/second for 1 minute
- **Spike test:** Burst to 100 requests/second (simulates email campaign)
- **Threshold:** p95 < 1000ms, error rate < 1%

## Thresholds (Pass/Fail Criteria)

| Metric | Target | NFR Requirement |
|--------|--------|-----------------|
| Response Time (p95) | < 500ms | Performance |
| Response Time (p99) | < 2000ms | Performance |
| Error Rate | < 1% | Reliability |
| Throughput | > 100 RPS | Scalability |

## Output

Test results are saved to `test-results/`:
- `health-load-test.json`
- `admin-api-load-test.json`
- `brevo-webhook-load-test.json`

## Interpreting Results

```
          /\      |‾‾| /‾‾/   /‾‾/
     /\  /  \     |  |/  /   /  /
    /  \/    \    |     (   /   ‾‾\
   /          \   |  |\  \ |  (‾)  |
  / __________ \  |__| \__\ \_____/

     execution: local
        script: tests/load/health.js
        output: -

     scenarios: (100.00%) 1 scenario, 50 max VUs, 3m30s max duration

     ✓ health status is 200
     ✓ health response time < 500ms

     checks.....................: 100.00% ✓ 1234  ✗ 0
     http_req_duration..........: avg=45ms min=12ms max=234ms p(95)=98ms
     http_reqs..................: 1234    20.5/s
```

### Key Metrics:
- **http_req_duration**: Response time statistics
- **http_reqs**: Total requests and requests per second
- **checks**: Pass/fail assertions
- **p(95)**: 95th percentile (95% of requests are faster than this)

## CI/CD Integration

Add to GitHub Actions:
```yaml
- name: Run Load Tests
  run: |
    k6 run --out json=test-results/load-test.json tests/load/health.js
  env:
    BASE_URL: ${{ secrets.STAGING_URL }}
```

## Troubleshooting

### "connection refused"
Server not running. Start with `npm run dev` first.

### "401 Unauthorized" on admin APIs
Expected if no auth token provided. Test validates response time, not auth.

### High error rate on webhook
Check `BREVO_WEBHOOK_SECRET` environment variable.

---

**Generated by:** testarch-framework workflow
**Date:** 2026-01-17
